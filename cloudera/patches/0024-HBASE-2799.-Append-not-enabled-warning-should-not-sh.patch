From c5361373f24d793ed11cf5935649b2d0bc920658 Mon Sep 17 00:00:00 2001
From: Todd Lipcon <todd@cloudera.com>
Date: Thu, 7 Oct 2010 22:05:20 -0700
Subject: [PATCH 24/30] HBASE-2799. "Append not enabled" warning should not show if hbase root dir isn't on DFS

Author: Michael Stack
---
 .../java/org/apache/hadoop/hbase/util/FSUtils.java |   10 ++++
 src/main/resources/hbase-webapps/master/master.jsp |    2 +-
 .../org/apache/hadoop/hbase/util/TestFSUtils.java  |   48 ++++++++++++++++++++
 3 files changed, 59 insertions(+), 1 deletions(-)
 create mode 100644 src/test/java/org/apache/hadoop/hbase/util/TestFSUtils.java

diff --git a/src/main/java/org/apache/hadoop/hbase/util/FSUtils.java b/src/main/java/org/apache/hadoop/hbase/util/FSUtils.java
index 5cf3481..530466e 100644
--- a/src/main/java/org/apache/hadoop/hbase/util/FSUtils.java
+++ b/src/main/java/org/apache/hadoop/hbase/util/FSUtils.java
@@ -590,6 +590,16 @@ public class FSUtils {
     return append;
   }
 
+  /**
+   * @param conf
+   * @return True if this filesystem whose scheme is 'hdfs'.
+   * @throws IOException
+   */
+  public static boolean isHDFS(final Configuration conf) throws IOException {
+    FileSystem fs = FileSystem.get(conf);
+    String scheme = fs.getUri().getScheme();
+    return scheme.equalsIgnoreCase("hdfs");
+  }
 
   /*
    * Recover file lease. Used when a file might be suspect to be had been left open by another process. <code>p</code>
diff --git a/src/main/resources/hbase-webapps/master/master.jsp b/src/main/resources/hbase-webapps/master/master.jsp
index 2c01d46..cdc2098 100644
--- a/src/main/resources/hbase-webapps/master/master.jsp
+++ b/src/main/resources/hbase-webapps/master/master.jsp
@@ -48,7 +48,7 @@
   for details.
   </div>
 <% } %>
-<% if (!FSUtils.isAppendSupported(conf)) { %>
+<% if (!FSUtils.isAppendSupported(conf) && FSUtils.isHDFS(conf)) { %>
   <div class="warning">
   You are currently running the HMaster without HDFS append support enabled.
   This may result in data loss.
diff --git a/src/test/java/org/apache/hadoop/hbase/util/TestFSUtils.java b/src/test/java/org/apache/hadoop/hbase/util/TestFSUtils.java
new file mode 100644
index 0000000..c8fc065
--- /dev/null
+++ b/src/test/java/org/apache/hadoop/hbase/util/TestFSUtils.java
@@ -0,0 +1,48 @@
+/**
+ * Copyright 2010 The Apache Software Foundation
+ *
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.hbase.util;
+
+import static org.junit.Assert.assertFalse;
+import static org.junit.Assert.assertTrue;
+
+import org.apache.hadoop.hbase.HBaseTestingUtility;
+import org.apache.hadoop.hdfs.MiniDFSCluster;
+import org.junit.Test;
+
+/**
+ * Test {@link FSUtils}.
+ */
+public class TestFSUtils {
+  @Test public void testIsHDFS() throws Exception {
+    HBaseTestingUtility htu = new HBaseTestingUtility();
+    htu.getConfiguration().setBoolean("dfs.support.append", false);
+    assertFalse(FSUtils.isHDFS(htu.getConfiguration()));
+    assertFalse(FSUtils.isAppendSupported(htu.getConfiguration()));
+    htu.getConfiguration().setBoolean("dfs.support.append", true);
+    MiniDFSCluster cluster = null;
+    try {
+      cluster = htu.startMiniDFSCluster(1);
+      assertTrue(FSUtils.isHDFS(htu.getConfiguration()));
+      assertTrue(FSUtils.isAppendSupported(htu.getConfiguration()));
+    } finally {
+      if (cluster != null) cluster.shutdown();
+    }
+  }
+}
-- 
1.7.0.4

