From 62bec1e3c6a34bae54dbe05bf9c473ef401eb3fd Mon Sep 17 00:00:00 2001
From: Todd Lipcon <todd@cloudera.com>
Date: Thu, 7 Oct 2010 18:34:43 -0700
Subject: [PATCH 22/30] CLOUDERA-BUILD. Change wrapper scripts to not be dependent on setting a bunch of environment variables

Fixes issues where /usr/lib/hbase/bin/hbase would fail, not finding the hadoop jars.
---
 bin/hbase                 |   12 +++++++++++-
 bin/hbase-config.sh       |    5 +++++
 cloudera/install_hbase.sh |   31 +++++++++----------------------
 3 files changed, 25 insertions(+), 23 deletions(-)

diff --git a/bin/hbase b/bin/hbase
index ec92f7b..b36593b 100755
--- a/bin/hbase
+++ b/bin/hbase
@@ -42,7 +42,7 @@
 #
 #   MAVEN_HOME       Where mvn is installed.
 #
-bin=`dirname "$0"`
+bin=`dirname "$BASH_SOURCE"`
 bin=`cd "$bin">/dev/null; pwd`
 
 # This will set HBASE_HOME, etc.
@@ -175,6 +175,16 @@ if [ "$HBASE_CLASSPATH" != "" ]; then
   CLASSPATH=${CLASSPATH}:${HBASE_CLASSPATH}
 fi
 
+# And very last, add other project configuration dirs - this
+# allows someone to override the hdfs config by putting an hdfs-site
+# in hbase's conf dir, for example
+if [ -n "$ZOOKEEPER_CONF_DIR" ]; then
+  CLASSPATH=${CLASSPATH}:${ZOOKEEPER_CONF_DIR}
+fi
+if [ -n "$HADOOP_CONF_DIR" ]; then
+  CLASSPATH=${CLASSPATH}:${HADOOP_CONF_DIR}
+fi
+
 # default log directory & file
 if [ "$HBASE_LOG_DIR" = "" ]; then
   HBASE_LOG_DIR="$HBASE_HOME/logs"
diff --git a/bin/hbase-config.sh b/bin/hbase-config.sh
index 2415b53..32d495d 100644
--- a/bin/hbase-config.sh
+++ b/bin/hbase-config.sh
@@ -78,11 +78,16 @@ HBASE_REGIONSERVERS="${HBASE_REGIONSERVERS:-$HBASE_CONF_DIR/regionservers}"
 # List of hbase secondary masters.
 HBASE_BACKUP_MASTERS="${HBASE_BACKUP_MASTERS:-$HBASE_CONF_DIR/backup-masters}"
 
+
 # Source the hbase-env.sh.  Will have JAVA_HOME defined.
 if [ -f "${HBASE_CONF_DIR}/hbase-env.sh" ]; then
   . "${HBASE_CONF_DIR}/hbase-env.sh"
 fi
 
+# Set up dependency configuration dirs if they aren't already set
+ZOOKEEPER_CONF_DIR=${ZOOKEEPER_CONF_DIR-/etc/zookeeper}
+HADOOP_CONF_DIR=${HADOOP_CONF_DIR-/etc/hadoop-0.20/conf}
+
 if [ -z "$JAVA_HOME" ]; then
   for candidate in \
     /usr/lib/jvm/java-6-sun \
diff --git a/cloudera/install_hbase.sh b/cloudera/install_hbase.sh
index 65f7e71..dd96245 100755
--- a/cloudera/install_hbase.sh
+++ b/cloudera/install_hbase.sh
@@ -94,7 +94,13 @@ install -d -m 0755 $PREFIX/$BIN_DIR
 install -d -m 0755 $PREFIX/$ETC_DIR
 
 cp -ra lib/* ${PREFIX}/${LIB_DIR}/lib/
-cp hbase*.jar $PREFIX/$LIB_DIR
+cp hbase*.jar $PREFIX/$LIB_DIR/
+
+# Make an unversioned jar symlink so that other
+# packages that depend on us can link in.
+for x in $PREFIX/hbase*jar ; do
+  ln -s $(basename $x) $PREFIX/$LIB_DIR/hbase.jar
+done
 cp -a docs/* $PREFIX/$DOC_DIR
 cp *.txt $PREFIX/$DOC_DIR/
 cp -a hbase-webapps $PREFIX/$LIB_DIR
@@ -104,30 +110,11 @@ cp -a bin/* $PREFIX/$BIN_DIR/
 
 ln -s $ETC_DIR/conf $PREFIX/$LIB_DIR/conf
 
+install -d -m 0755 $PREFIX/usr/bin
+ 
 wrapper=$PREFIX/usr/bin/hbase
-mkdir -p `dirname $wrapper`
 cat > $wrapper <<EOF
 #!/bin/sh
-export ZOOKEEPER_CONF=\${ZOOKEEPER_CONF:-/etc/zookeeper}
-export HADOOP_CONF=\${HADOOP_CONF:-/etc/hadoop-0.20/conf}
-export ZOOKEEPER_HOME=\${ZOOKEEPER_HOME:-/usr/lib/zookeeper}
-export HADOOP_HOME=\${HADOOP_HOME:-/usr/lib/hadoop-0.20}
-export HBASE_CLASSPATH=\$ZOOKEEPER_CONF:\$HADOOP_CONF:\$HADOOP_HOME/*:\$HADOOP_HOME/lib/*:\$ZOOKEEPER_HOME/*:\$ZOOKEEPER_HOME/lib/*:\$HBASE_CLASSPATH
-export HBASE_PID_DIR=/var/run/hbase
 exec /usr/lib/hbase/bin/hbase "\$@"
 EOF
 chmod 755 $wrapper
-
-wrapper=$PREFIX/usr/bin/hbase-daemon.sh
-mkdir -p `dirname $wrapper`
-cat > $wrapper <<EOF
-#!/bin/sh
-export ZOOKEEPER_CONF=\${ZOOKEEPER_CONF:-/etc/zookeeper}
-export HADOOP_CONF=\${HADOOP_CONF:-/etc/hadoop-0.20/conf}
-export ZOOKEEPER_HOME=\${ZOOKEEPER_HOME:-/usr/lib/zookeeper}
-export HADOOP_HOME=\${HADOOP_HOME:-/usr/lib/hadoop-0.20}
-export HBASE_CLASSPATH=\$ZOOKEEPER_CONF:\$HADOOP_CONF:\$HADOOP_HOME/*:\$ZOOKEEPER_HOME/*:\$HBASE_CLASSPATH
-export HBASE_PID_DIR=/var/run/hbase
-exec /usr/lib/hbase/bin/hbase-daemon.sh "\$@"
-EOF
-chmod 755 $wrapper
-- 
1.7.0.4

